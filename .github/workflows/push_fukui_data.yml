name: 福井県のデータをGitHubへPush

on:
  repository_dispatch:
  # スケジュール実行の例。 以下は昼の12:30JSTに実行する例
  # schedule:
  #   - cron: 30 12 * * *

jobs:
  build:
    runs-on: ubuntu-18.04
    steps:
      - name: 共通のデータを出力
        id: metadatas
        uses: actions/github-script@0.9.0
        with:
          update-push-branch: ${{ secrets.SCHEDULED_UPDATE_PUSH_BRANCH }}
          script: |
            console.log(context)

            const baseBranch = context.payload.client_payload != null && typeof context.payload.client_payload.base_branch === 'string' && context.payload.client_payload.base_branch.length > 1
              ? context.payload.client_payload.base_branch : core.getInput('update-push-branch') || context.payload.repository.default_branch.replace('refs/heads/', '')

            core.setOutput('head-branch', 'update_data/updatejson')
            core.setOutput('base-branch', baseBranch)
            core.setOutput('current-date', (new Date).toString())

      - name: Gitを設定
        run: |
          git config --global user.name github-actions
          git config --global user.email actions@github.com

      - name: リポジトリをチェックアウト
        uses: actions/checkout@v2
        with:
          ref: ${{ steps.metadatas.outputs.base-branch }}

      - name: Dockerイメージをビルド
        env:
          CSV_FETCH_ENV: ${{ secrets.CSV_FETCH_ENV }}
        run: |
          echo "$CSV_FETCH_ENV" > covid19_fukui/.env.local
          docker-compose build fetch_fukui_data

      - name: data/*.jsonを作成
        run: docker-compose run fetch_fukui_data

      - name: ブランチを作成
        id: branch
        env:
          TZ: JST-9
          BRANCH_NAME: ${{ steps.metadatas.outputs.head-branch }}
        run: |
          git switch -c $BRANCH_NAME
          git push -f -u origin $BRANCH_NAME

      - name: コミット
        run: |
          git add .
          git commit -m "[Auto] データを更新 ${{ steps.metadatas.outputs.current-date }}"

      - name: プッシュ
        run: git push

      - name: Pull request を作成
        uses: actions/github-script@0.9.0
        with:
          script: |
            github.pulls.create({
              owner: context.payload.repository.owner.login,
              repo: context.payload.repository.name,
              title: '[Auto]データ更新 ${{ steps.metadatas.outputs.current-date }}',
              head: '${{ steps.metadatas.outputs.head-branch }}',
              base: '${{ steps.metadatas.outputs.base-branch }}',
            })
